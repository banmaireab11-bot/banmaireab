<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Register ‚Äì ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-gray-100">

<!-- Loading -->
<div id="loading" class="hidden fixed inset-0 bg-black/40 z-50 flex items-center justify-center">
  <div class="bg-white px-6 py-4 rounded shadow text-lg">
    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
  </div>
</div>

<div class="max-w-xl mx-auto mt-10 bg-white p-6 rounded shadow">
  <h1 class="text-2xl font-bold mb-4 text-center">
    Register ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö
  </h1>

  <form id="regForm" class="space-y-3">

    <select id="prefix" class="w-full border p-2 rounded" required>
      <option value="">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
      <option>‡∏ô‡∏≤‡∏¢</option>
      <option>‡∏ô‡∏≤‡∏á</option>
      <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select>

    <input id="first_name" class="w-full border p-2 rounded" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required>
    <input id="last_name" class="w-full border p-2 rounded" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>

    <input id="citizen_id" class="w-full border p-2 rounded"
      placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" maxlength="13" required>

    <textarea id="address" class="w-full border p-2 rounded" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" required></textarea>

    <select id="blood_group" class="w-full border p-2 rounded" required>
      <option value="">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</option>
      <option>A</option>
      <option>B</option>
      <option>AB</option>
      <option>O</option>
    </select>

    <input id="email" type="email" class="w-full border p-2 rounded" placeholder="Email" required>

    <input id="slip" type="file" accept="image/*" class="w-full" required>

    <button class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
      Register ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
    </button>

  </form>
</div>

<script>
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
// üëâ ‡πÉ‡∏ä‡πâ sb ‡πÅ‡∏ó‡∏ô
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

const loading = document.getElementById('loading')
const showLoading = (v=true)=>loading.classList.toggle('hidden', !v)

document.getElementById('regForm').addEventListener('submit', async e=>{
  e.preventDefault()
  showLoading(true)

  const cid = citizen_id.value

  // ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥
  const { data: dup } = await sb
    .from('registrations')
    .select('id')
    .eq('citizen_id', cid)

  if(dup.length){
    showLoading(false)
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß','error')
    return
  }

  // upload slip
  const file = slip.files[0]
  const filePath = `${cid}_${Date.now()}.jpg`

  const { error } = await sb
    .storage.from('payment-slips')
    .upload(filePath, file)

  if(error){
    showLoading(false)
    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î','‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','error')
    return
  }

  const slip_url = sb
    .storage.from('payment-slips')
    .getPublicUrl(filePath).data.publicUrl

  // insert
  await sb.from('registrations').insert({
    prefix: prefix.value,
    first_name: first_name.value,
    last_name: last_name.value,
    citizen_id: cid,
    address: address.value,
    blood_group: blood_group.value,
    email: email.value,
    slip_url
  })

  fetch("SUPABASE_FUNCTION_TELEGRAM_URL",{ method:"POST" })

  showLoading(false)
  Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢','success')
  e.target.reset()
})
</script>

</body>
</html>
