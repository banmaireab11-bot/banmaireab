<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Race Registration | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: linear-gradient(to bottom right, #e0f2fe, #f8fafc);
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<!-- ================= Loading ================= -->
<div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-sky-900/40 backdrop-blur-sm"></div>
  <div class="bg-white px-8 py-6 rounded-xl shadow text-center">
    <div class="w-12 h-12 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin mx-auto mb-3"></div>
    <p id="loadingText">กำลังตรวจสอบสลิป</p>
  </div>
</div>

<div class="w-full max-w-xl bg-white rounded-xl shadow overflow-hidden">

<!-- Header -->
<div class="bg-sky-600 text-white p-6 text-center relative">
  <h1 class="text-2xl font-bold">สมัครงานวิ่ง โรงเรียนบ้านไม้เรียบ</h1>
  <p class="text-sm mt-1">ระบบรับสมัครอย่างเป็นทางการ</p>
</div>

<form id="registerForm" class="p-6 space-y-4">

<input id="first_name" class="border rounded px-3 py-2 w-full" placeholder="ชื่อ" required>
<input id="last_name" class="border rounded px-3 py-2 w-full" placeholder="นามสกุล" required>

<input id="phone" class="border rounded px-3 py-2 w-full"
  placeholder="เบอร์โทรศัพท์"
  oninput="this.value=this.value.replace(/[^0-9]/g,'')"
  maxlength="10"
  required>

<input id="citizen_id" class="border rounded px-3 py-2 w-full"
  placeholder="เลขบัตรประชาชน / Passport"
  required>

<input id="email" type="email" class="border rounded px-3 py-2 w-full" placeholder="อีเมล" required>

<input id="slip" type="file" accept="image/*" required>

<button id="submitBtn"
  class="w-full bg-sky-600 text-white py-2 rounded">
  สมัครเข้าร่วม
</button>

</form>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
const OCR_URL =
  "https://YOUR_PROJECT_ID.supabase.co/functions/v1/ocr-slip"

const REGISTRATION_FEE = {
  THB: 500,
  USD: 15
}

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ================= SUBMIT ================= */
registerForm.addEventListener("submit", async e => {
  e.preventDefault()
  loading.classList.remove("hidden")

  try {
    const cid = citizen_id.value.trim()
    const ext = slip.files[0].name.split(".").pop()
    const path = `${cid}_${Date.now()}.${ext}`

    await sb.storage.from("payment-slips").upload(path, slip.files[0])
    const slip_url = sb.storage.from("payment-slips")
      .getPublicUrl(path).data.publicUrl

    // OCR
    loadingText.innerText = "กำลังตรวจสอบยอดเงิน..."
    const ocrRes = await fetch(OCR_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_KEY}`
      },
      body: JSON.stringify({ imageUrl: slip_url })
    })

    const ocr = await ocrRes.json()

    if (!ocr.valid) {
      throw "ไม่ผ่าน OCR"
    }

    const expected = REGISTRATION_FEE[ocr.currency]
    if (!expected || ocr.amount !== expected) {
      throw `ยอดเงินไม่ถูกต้อง (${ocr.amount} ${ocr.currency})`
    }

    await sb.from("registrations").insert({
      first_name: first_name.value,
      last_name: last_name.value,
      phone: phone.value,
      citizen_id: cid,
      email: email.value,
      slip_url,
      status: "pending",
      ocr_amount: ocr.amount,
      ocr_currency: ocr.currency,
      ocr_text: ocr.text
    })

    Swal.fire("สำเร็จ", "ระบบได้รับข้อมูลแล้ว", "success")
    registerForm.reset()

  } catch (err) {
    Swal.fire("ไม่สำเร็จ", err.toString(), "error")
  }

  loading.classList.add("hidden")
})
</script>

</body>
</html>
