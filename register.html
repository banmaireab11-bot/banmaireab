<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Race Registration | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    background: linear-gradient(to bottom right, #e0f2fe, #f8fafc);
  }
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<!-- ================= Loading Overlay ================= -->
<div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-sky-900/40 backdrop-blur-sm"></div>
  <div class="relative bg-white rounded-xl shadow-xl px-8 py-6 w-80 text-center">
    <div class="flex justify-center mb-4">
      <div class="w-14 h-14 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
    </div>
    <p id="loadingText" class="text-lg font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ</p>
  </div>
</div>

<div class="w-full max-w-xl bg-white rounded-xl shadow-lg overflow-hidden">

<!-- ================= Header ================= -->
<div class="bg-sky-600 text-white p-6 text-center relative">
  <h1 id="title" class="text-2xl font-bold">
    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö
  </h1>
  <p id="subtitle" class="text-sm mt-1">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
  </p>

  <!-- Language Switch -->
  <div class="absolute top-4 right-4 flex gap-2 text-sm">
    <button onclick="setLang('th')" class="px-2 py-1 bg-white/20 rounded">TH</button>
    <button onclick="setLang('en')" class="px-2 py-1 bg-white/20 rounded">EN</button>
  </div>
</div>

<!-- ================= Form ================= -->
<form id="registerForm" class="p-6 space-y-4">

<select id="prefix" class="w-full border rounded px-3 py-2" required></select>

<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
  <input id="first_name" class="border rounded px-3 py-2"
    data-i18n-placeholder="fname" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required>
  <input id="last_name" class="border rounded px-3 py-2"
    data-i18n-placeholder="lname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
</div>

<input id="phone" class="w-full border rounded px-3 py-2"
  maxlength="10"
  oninput="this.value=this.value.replace(/[^0-9]/g,'')"
  data-i18n-placeholder="phone"
  placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å"
  required>

<div>
  <input id="citizen_id" class="w-full border rounded px-3 py-2"
    maxlength="20"
    data-i18n-placeholder="cid"
    placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport"
    required>
  <p id="idFeedback" class="text-sm mt-1"></p>
</div>

<textarea id="address" class="w-full border rounded px-3 py-2"
  data-i18n-placeholder="address"
  placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" required></textarea>

<select id="blood_group" class="w-full border rounded px-3 py-2" required>
  <option value="" data-i18n="blood">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</option>
  <option>A</option><option>B</option><option>AB</option><option>O</option>
</select>

<input id="email" type="email"
  class="w-full border rounded px-3 py-2"
  data-i18n-placeholder="email"
  placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>

<div>
  <label id="slipLabel" class="block text-sm mb-1">
    ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
  </label>
  <input id="slip" type="file" accept="image/*" required>
</div>

<button
  id="submitBtn"
  disabled
  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed transition">
  ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
</button>

</form>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ================= I18N ================= */
const i18n = {
  th: {
    title: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö",
    subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£",
    prefixes: [
      { value: "", text: "‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤" },
      { value: "‡∏ô‡∏≤‡∏¢", text: "‡∏ô‡∏≤‡∏¢" },
      { value: "‡∏ô‡∏≤‡∏á", text: "‡∏ô‡∏≤‡∏á" },
      { value: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß", text: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" }
    ],
    fname: "‡∏ä‡∏∑‡πà‡∏≠",
    lname: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    phone: "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå 10 ‡∏´‡∏•‡∏±‡∏Å",
    cid: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport",
    address: "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà",
    blood: "‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
    email: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    slip: "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
    submit: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°",
    loading: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ",
    validThai: "‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡πÑ‡∏ó‡∏¢ ‚úî",
    validPassNum: "Passport (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) ‚úî",
    validPass: "Passport ‚úî",
    invalid: "‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"
  },
  en: {
    title: "Race Registration ‚Äì Ban Mai Riab School",
    subtitle: "Official Registration System",
    prefixes: [
      { value: "", text: "Title" },
      { value: "Mr.", text: "Mr." },
      { value: "Mrs.", text: "Mrs." },
      { value: "Ms.", text: "Ms." }
    ],
    fname: "First Name",
    lname: "Last Name",
    phone: "Phone number (10 digits)",
    cid: "Citizen ID / Passport",
    address: "Address",
    blood: "Blood Group",
    email: "Email",
    slip: "Upload payment slip",
    submit: "Register",
    loading: "Uploading slip",
    validThai: "Thai Citizen ID ‚úî",
    validPassNum: "Passport (numeric) ‚úî",
    validPass: "Passport ‚úî",
    invalid: "Invalid number"
  }
}

let currentLang = "th"

/* ================= PREFIX ================= */
function renderPrefixOptions() {
  const s = prefix
  const v = s.value
  s.innerHTML = ""
  i18n[currentLang].prefixes.forEach(p => {
    const o = document.createElement("option")
    o.value = p.value
    o.textContent = p.text
    s.appendChild(o)
  })
  s.value = v || ""
}

/* ================= LANGUAGE ================= */
function setLang(lang) {
  currentLang = lang
  document.documentElement.lang = lang
  title.innerText = i18n[lang].title
  subtitle.innerText = i18n[lang].subtitle
  slipLabel.innerText = i18n[lang].slip
  submitBtn.innerText = i18n[lang].submit
  loadingText.innerText = i18n[lang].loading

  document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
    el.placeholder = i18n[lang][el.dataset.i18nPlaceholder]
  })
  document.querySelectorAll("[data-i18n]").forEach(el => {
    el.innerText = i18n[lang][el.dataset.i18n]
  })

  renderPrefixOptions()
  triggerRealtimeCheck()
}

/* ================= VALIDATION ================= */
function isSequentialNumber(str) {
  return "0123456789".includes(str) || "9876543210".includes(str)
}
function isRepeatedNumber(str) {
  return /^(\d)\1+$/.test(str)
}
function isValidThaiCitizenID(id) {
  if (!/^\d{13}$/.test(id)) return false
  if (isRepeatedNumber(id)) return false
  let sum = 0
  for (let i = 0; i < 12; i++) sum += id[i] * (13 - i)
  return ((11 - sum % 11) % 10) === parseInt(id[12])
}
function isValidCitizenOrPassport(v) {
  if (/^\d+$/.test(v)) {
    if (v.length === 13) return isValidThaiCitizenID(v)
    if (v.length >= 6 && v.length <= 9) {
      if (isSequentialNumber(v)) return false
      if (isRepeatedNumber(v)) return false   // üî¥ ‡∏õ‡∏¥‡∏î 000000
      return true
    }
    return false
  }
  return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z0-9]{6,20}$/.test(v)
}
function getIdType(v) {
  if (/^\d+$/.test(v)) {
    if (v.length === 13) return "thai"
    return "passport_numeric"
  }
  return "passport"
}
function isValidPhone(p) {
  return /^\d{10}$/.test(p)
}

/* ================= BUTTON ================= */
function setSubmitEnabled(ok) {
  submitBtn.disabled = !ok
  submitBtn.className = ok
    ? "w-full bg-sky-600 text-white py-2 rounded hover:bg-sky-700"
    : "w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed"
}

/* ================= REALTIME ================= */
function triggerRealtimeCheck() {
  const v = citizen_id.value.trim()
  if (!v) {
    idFeedback.textContent = ""
    setSubmitEnabled(false)
    return
  }
  if (isValidCitizenOrPassport(v)) {
    const t = getIdType(v)
    idFeedback.textContent =
      "‚úì " +
      (t === "thai"
        ? i18n[currentLang].validThai
        : t === "passport_numeric"
        ? i18n[currentLang].validPassNum
        : i18n[currentLang].validPass)
    idFeedback.className = "text-sm mt-1 text-green-600"
    setSubmitEnabled(true)
  } else {
    idFeedback.textContent = "‚úó " + i18n[currentLang].invalid
    idFeedback.className = "text-sm mt-1 text-red-600"
    setSubmitEnabled(false)
  }
}
citizen_id.addEventListener("input", triggerRealtimeCheck)

/* ================= INIT ================= */
setLang("th")
</script>

</body>
</html>
