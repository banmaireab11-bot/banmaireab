<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Race Registration | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    background: linear-gradient(to bottom right, #e0f2fe, #f8fafc);
  }
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<!-- ================= Loading Overlay ================= -->
<div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-sky-900/40 backdrop-blur-sm"></div>
  <div class="relative bg-white rounded-xl shadow-xl px-8 py-6 w-80 text-center">
    <div class="flex justify-center mb-4">
      <div class="w-14 h-14 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
    </div>
    <div class="text-sky-600 text-3xl mb-2">üì§</div>
    <p id="loadingTitle" class="text-lg font-semibold">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
    </p>
    <p id="loadingSub" class="text-sm text-gray-500">
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    </p>
  </div>
</div>

<div class="w-full max-w-xl bg-white rounded-xl shadow-lg overflow-hidden">

<!-- Header -->
<div class="bg-sky-600 text-white p-6 relative">
  <h1 id="title" class="text-2xl font-bold text-center">
    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö
  </h1>
  <p id="subtitle" class="text-center text-sm mt-1">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
  </p>

  <div class="absolute top-4 right-4 flex gap-2 text-sm">
    <button onclick="setLang('th')" class="px-2 py-1 bg-white/20 rounded">TH</button>
    <button onclick="setLang('en')" class="px-2 py-1 bg-white/20 rounded">EN</button>
  </div>
</div>

<!-- ================= Form ================= -->
<form id="registerForm" class="p-6 space-y-4">

<select id="prefix" class="w-full border rounded px-3 py-2" required>
  <option value="" data-i18n="prefix">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
  <option>‡∏ô‡∏≤‡∏¢</option>
  <option>‡∏ô‡∏≤‡∏á</option>
  <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
</select>

<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
  <input id="first_name" class="border rounded px-3 py-2"
    data-i18n-placeholder="fname" required>
  <input id="last_name" class="border rounded px-3 py-2"
    data-i18n-placeholder="lname" required>
</div>

<input id="phone" class="w-full border rounded px-3 py-2"
  maxlength="10"
  oninput="this.value=this.value.replace(/[^0-9]/g,'')"
  data-i18n-placeholder="phone"
  required>

<input id="citizen_id" class="w-full border rounded px-3 py-2"
  maxlength="20"
  data-i18n-placeholder="cid"
  required>

<textarea id="address" class="w-full border rounded px-3 py-2"
  data-i18n-placeholder="address"
  required></textarea>

<select id="blood_group" class="w-full border rounded px-3 py-2" required>
  <option value="" data-i18n="blood">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</option>
  <option>A</option><option>B</option><option>AB</option><option>O</option>
</select>

<input id="email" type="email"
  class="w-full border rounded px-3 py-2"
  data-i18n-placeholder="email"
  required>

<div>
  <label id="slipLabel" class="block text-sm mb-1">
    ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
  </label>
  <input id="slip" type="file" accept="image/*" required>
</div>

<button id="submitBtn"
  class="w-full bg-sky-600 text-white py-2 rounded hover:bg-sky-700">
  ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
</button>

</form>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ================= VALIDATION ================= */
function isValidThaiCitizenID(id){
  if(!/^\d{13}$/.test(id)) return false
  let sum = 0
  for(let i=0;i<12;i++){
    sum += parseInt(id[i],10) * (13 - i)
  }
  const check = (11 - (sum % 11)) % 10
  return check === parseInt(id[12],10)
}

function isValidCitizenOrPassport(value){
  // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡πâ‡∏ß‡∏ô
  if (/^\d+$/.test(value)) {
    if (value.length === 13) {
      return isValidThaiCitizenID(value)
    }
    return false
  }
  // Passport ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß
  if (/^(?=.*[A-Za-z])[A-Za-z0-9]{6,20}$/.test(value)) {
    return true
  }
  return false
}

function isValidPhone(p){
  return /^\d{10}$/.test(p)
}

/* ================= I18N ================= */
const i18n = {
  th:{
    prefix:"‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤",
    fname:"‡∏ä‡∏∑‡πà‡∏≠",
    lname:"‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    phone:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå",
    cid:"‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô / Passport",
    address:"‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà",
    blood:"‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
    email:"‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    slip:"‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
    submit:"‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°",
    cidErr:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ Passport ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á",
    phoneErr:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 10 ‡∏´‡∏•‡∏±‡∏Å",
    successTitle:"‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
    successMsg:"‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ó‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏£‡∏≤‡∏ö‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•"
  },
  en:{
    prefix:"Title",
    fname:"First Name",
    lname:"Last Name",
    phone:"Phone",
    cid:"Citizen ID / Passport",
    address:"Address",
    blood:"Blood Group",
    email:"Email",
    slip:"Payment Slip",
    submit:"Register",
    cidErr:"Please enter a valid Thai Citizen ID or Passport number",
    phoneErr:"Phone number must be 10 digits",
    successTitle:"Registration Successful",
    successMsg:"Your registration has been submitted. Please wait for approval. You will be notified via email."
  }
}

let currentLang = "th"

function setLang(lang){
  currentLang = lang
  document.documentElement.lang = lang

  title.innerText = i18n[lang].title || title.innerText
  subtitle.innerText = i18n[lang].subtitle || subtitle.innerText
  submitBtn.innerText = i18n[lang].submit
  slipLabel.innerText = i18n[lang].slip

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.innerText = i18n[lang][el.dataset.i18n]
  })
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    el.placeholder = i18n[lang][el.dataset.i18nPlaceholder]
  })
}

/* ================= FORM ================= */
const loading = document.getElementById("loading")
const showLoading = v => loading.classList.toggle("hidden", !v)

registerForm.addEventListener("submit", async e=>{
  e.preventDefault()
  showLoading(true)

  const cid = citizen_id.value.trim()
  const phoneVal = phone.value.trim()

  if(!isValidCitizenOrPassport(cid)){
    showLoading(false)
    Swal.fire("Error", i18n[currentLang].cidErr, "error")
    return
  }

  if(!isValidPhone(phoneVal)){
    showLoading(false)
    Swal.fire("Error", i18n[currentLang].phoneErr, "error")
    return
  }

  const { data: dup } = await sb
    .from("registrations")
    .select("id")
    .eq("citizen_id", cid)

  if(dup.length){
    showLoading(false)
    Swal.fire("Warning", "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß", "warning")
    return
  }

  const filePath = `${cid}_${Date.now()}.jpg`
  await sb.storage.from("payment-slips").upload(filePath, slip.files[0])

  const slip_url = sb.storage
    .from("payment-slips")
    .getPublicUrl(filePath).data.publicUrl

  await sb.from("registrations").insert({
    prefix: prefix.value,
    first_name: first_name.value,
    last_name: last_name.value,
    phone: phoneVal,
    citizen_id: cid,
    address: address.value,
    blood_group: blood_group.value,
    email: email.value,
    slip_url,
    status: "pending"
  })

  showLoading(false)
  Swal.fire(
    i18n[currentLang].successTitle,
    i18n[currentLang].successMsg,
    "success"
  )

  e.target.reset()
})

setLang("th")
</script>

</body>
</html>
