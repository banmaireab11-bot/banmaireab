<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Race Registration | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  body {
    background: linear-gradient(to bottom right, #e0f2fe, #f8fafc);
  }
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<!-- ================= Loading Overlay ================= -->
<div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-sky-900/40 backdrop-blur-sm"></div>

  <div class="relative bg-white rounded-xl shadow-xl px-8 py-6 w-80 text-center">
    <div class="flex justify-center mb-4">
      <div class="w-14 h-14 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
    </div>

    <div class="text-sky-600 text-3xl mb-2">üì§</div>

    <p id="loadingTitle" class="text-lg font-semibold text-gray-800">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
    </p>
    <p id="loadingSub" class="text-sm text-gray-500 mt-1">
      ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
    </p>
  </div>
</div>
<!-- =================================================== -->

<div class="w-full max-w-xl bg-white rounded-xl shadow-lg overflow-hidden">

  <!-- Header -->
  <div class="bg-sky-600 text-white p-6 relative">
    <h1 id="title" class="text-2xl font-bold text-center">
      ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö
    </h1>
    <p id="subtitle" class="text-center text-sm mt-1">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£
    </p>

    <!-- Language Switch -->
    <div class="absolute top-4 right-4 flex gap-2 text-sm">
      <button onclick="setLang('th')" class="px-2 py-1 bg-white/20 rounded">TH</button>
      <button onclick="setLang('en')" class="px-2 py-1 bg-white/20 rounded">EN</button>
    </div>
  </div>

  <!-- Form -->
  <form id="registerForm" class="p-6 space-y-4">

    <select id="prefix" class="w-full border rounded px-3 py-2" required>
      <option value="" data-i18n="prefix">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</option>
      <option>‡∏ô‡∏≤‡∏¢</option>
      <option>‡∏ô‡∏≤‡∏á</option>
      <option>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <input id="first_name" class="border rounded px-3 py-2"
        data-i18n-placeholder="fname" placeholder="‡∏ä‡∏∑‡πà‡∏≠" required>
      <input id="last_name" class="border rounded px-3 py-2"
        data-i18n-placeholder="lname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required>
    </div>

    <input id="citizen_id" class="w-full border rounded px-3 py-2"
      maxlength="13"
      data-i18n-placeholder="cid"
      placeholder="‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å" required>

    <textarea id="address" class="w-full border rounded px-3 py-2"
      data-i18n-placeholder="address"
      placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" required></textarea>

    <select id="blood_group" class="w-full border rounded px-3 py-2" required>
      <option value="" data-i18n="blood">‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î</option>
      <option>A</option>
      <option>B</option>
      <option>AB</option>
      <option>O</option>
    </select>

    <input id="email" type="email"
      class="w-full border rounded px-3 py-2"
      data-i18n-placeholder="email"
      placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" required>

    <div>
      <label id="slipLabel" class="block text-sm mb-1">
        ‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
      </label>
      <input id="slip" type="file" accept="image/*" required>
    </div>

    <button
      id="submitBtn"
      class="w-full bg-sky-600 text-white py-2 rounded hover:bg-sky-700 transition">
      ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°
    </button>

  </form>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io" // ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ .env ‡∏ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* ================= I18N ================= */
const i18n = {
  th: {
    title: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö",
    subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£",
    prefix: "‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤",
    fname: "‡∏ä‡∏∑‡πà‡∏≠",
    lname: "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",
    cid: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å",
    address: "‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà",
    blood: "‡∏Å‡∏£‡∏∏‡πä‡∏õ‡πÄ‡∏•‡∏∑‡∏≠‡∏î",
    email: "‡∏≠‡∏µ‡πÄ‡∏°‡∏•",
    slip: "‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
    submit: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°",
    success: "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß",
    dup: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß",
    cidErr: "‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô 13 ‡∏´‡∏•‡∏±‡∏Å",
    loadingTitle: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ",
    loadingSub: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏≠‡∏¢‡πà‡∏≤‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ"
  },
  en: {
    title: "Race Registration ‚Äì Ban Mai Riab School",
    subtitle: "Official Registration System",
    prefix: "Title",
    fname: "First Name",
    lname: "Last Name",
    cid: "Citizen ID (13 digits)",
    address: "Address",
    blood: "Blood Group",
    email: "Email",
    slip: "Upload Payment Slip",
    submit: "Register",
    success: "Registration completed",
    dup: "This citizen ID is already registered",
    cidErr: "Citizen ID must be 13 digits",
    loadingTitle: "Uploading payment slip",
    loadingSub: "Please wait. Do not close this page."
  }
}

let currentLang = "th"

/* ================= LANGUAGE ================= */
function setLang(lang){
  currentLang = lang
  document.documentElement.lang = lang

  document.getElementById("title").innerText = i18n[lang].title
  document.getElementById("subtitle").innerText = i18n[lang].subtitle
  document.getElementById("submitBtn").innerText = i18n[lang].submit
  document.getElementById("slipLabel").innerText = i18n[lang].slip
  document.getElementById("loadingTitle").innerText = i18n[lang].loadingTitle
  document.getElementById("loadingSub").innerText = i18n[lang].loadingSub

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    el.innerText = i18n[lang][el.dataset.i18n]
  })
  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    el.placeholder = i18n[lang][el.dataset.i18nPlaceholder]
  })
}

/* ================= FORM ================= */
const loading = document.getElementById('loading')
const showLoading = v => loading.classList.toggle('hidden', !v)
const isValidCid = id => /^\d{13}$/.test(id)

document.getElementById('registerForm').addEventListener('submit', async e=>{
  e.preventDefault()
  showLoading(true)

  const cid = citizen_id.value.trim()

  if(!isValidCid(cid)){
    showLoading(false)
    Swal.fire("Error", i18n[currentLang].cidErr, "error")
    return
  }

  // ‡πÄ‡∏ä‡πá‡∏Å‡∏ã‡πâ‡∏≥
  const { data: dup } = await sb
    .from('registrations')
    .select('id')
    .eq('citizen_id', cid)

  if(dup.length){
    showLoading(false)
    Swal.fire("Warning", i18n[currentLang].dup, "warning")
    return
  }

  // upload slip
  const filePath = `${cid}_${Date.now()}.jpg`
  await sb.storage.from('payment-slips').upload(filePath, slip.files[0])

  const slip_url = sb.storage
    .from('payment-slips')
    .getPublicUrl(filePath).data.publicUrl

  // insert
  await sb.from('registrations').insert({
    prefix: prefix.value,
    first_name: first_name.value,
    last_name: last_name.value,
    citizen_id: cid,
    address: address.value,
    blood_group: blood_group.value,
    email: email.value,
    slip_url,
    status: "pending"
  })

  // üîî ‡πÅ‡∏à‡πâ‡∏á LINE (‡πÑ‡∏°‡πà await ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ö‡∏•‡πá‡∏≠‡∏Å)
  fetch("https://etnvagsxrrglysavibfe.supabase.co/functions/v1/send-line", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_KEY}`
    },
    body: JSON.stringify({
      name: `${first_name.value} ${last_name.value}`,
      citizen_id: cid,
      blood_group: blood_group.value
    })
  })

  showLoading(false)
  Swal.fire("Success", i18n[currentLang].success, "success")
  e.target.reset()
})

setLang("th")
</script>


</body>
</html>
