<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Race Registration | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body {
  background: linear-gradient(to bottom right, #e0f2fe, #f8fafc);
}
</style>
</head>

<body class="min-h-screen flex items-center justify-center px-4">

<!-- ================= Loading ================= -->
<div id="loading" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 bg-sky-900/40 backdrop-blur-sm"></div>
  <div class="bg-white px-8 py-6 rounded-xl shadow text-center">
    <div class="w-12 h-12 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin mx-auto mb-3"></div>
    <p id="loadingText">กำลังตรวจสอบข้อมูล...</p>
  </div>
</div>

<div class="w-full max-w-xl bg-white rounded-xl shadow overflow-hidden">

<!-- ================= Header ================= -->
<div class="bg-sky-600 text-white p-6 text-center relative">
  <h1 id="title" class="text-2xl font-bold">สมัครงานวิ่ง โรงเรียนบ้านไม้เรียบ</h1>
  <p id="subtitle" class="text-sm mt-1">ระบบรับสมัครอย่างเป็นทางการ</p>

  <div class="absolute top-4 right-4 flex gap-2 text-sm">
    <button onclick="setLang('th')" class="px-2 py-1 bg-white/20 rounded">TH</button>
    <button onclick="setLang('en')" class="px-2 py-1 bg-white/20 rounded">EN</button>
  </div>
</div>

<!-- ================= Form ================= -->
<form id="registerForm" class="p-6 space-y-4">

<select id="prefix" class="w-full border rounded px-3 py-2" required></select>

<input id="first_name" class="w-full border rounded px-3 py-2" placeholder="ชื่อ" required>
<input id="last_name" class="w-full border rounded px-3 py-2" placeholder="นามสกุล" required>

<input id="phone" class="w-full border rounded px-3 py-2"
  placeholder="เบอร์โทรศัพท์ 10 หลัก"
  maxlength="10"
  oninput="this.value=this.value.replace(/[^0-9]/g,'')"
  required>

<div>
  <input id="citizen_id" class="w-full border rounded px-3 py-2"
    placeholder="เลขบัตรประชาชน / Passport"
    required>
  <p id="idFeedback" class="text-sm mt-1"></p>
</div>

<input id="email" type="email" class="w-full border rounded px-3 py-2" placeholder="อีเมล" required>

<input id="slip" type="file" accept="image/*" required>

<button id="submitBtn" disabled
  class="w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed">
  สมัครเข้าร่วม
</button>

</form>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
const OCR_FUNCTION_URL =
  "https://etnvagsxrrglysavibfe.supabase.co/functions/v1/ocr-slip"

const REGISTRATION_FEE = { THB: 500, USD: 15 }

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

/* ================= I18N ================= */
const i18n = {
  th: {
    title:"สมัครงานวิ่ง โรงเรียนบ้านไม้เรียบ",
    subtitle:"ระบบรับสมัครอย่างเป็นทางการ",
    prefixes:[
      {v:"",t:"คำนำหน้า"},
      {v:"นาย",t:"นาย"},
      {v:"นาง",t:"นาง"},
      {v:"นางสาว",t:"นางสาว"}
    ],
    valid:"ผ่าน ✔",
    invalid:"ไม่ผ่าน ✖",
    submit:"สมัครเข้าร่วม"
  },
  en: {
    title:"Race Registration – Ban Mai Riab School",
    subtitle:"Official Registration System",
    prefixes:[
      {v:"",t:"Title"},
      {v:"Mr.",t:"Mr."},
      {v:"Mrs.",t:"Mrs."},
      {v:"Ms.",t:"Ms."}
    ],
    valid:"Valid ✔",
    invalid:"Invalid ✖",
    submit:"Register"
  }
}
let currentLang="th"

/* ================= Helpers ================= */
const showLoading = v => loading.classList.toggle("hidden", !v)

function setSubmitEnabled(ok){
  submitBtn.disabled = !ok
  submitBtn.className = ok
    ? "w-full bg-sky-600 text-white py-2 rounded"
    : "w-full bg-gray-400 text-white py-2 rounded cursor-not-allowed"
}

/* ================= Validation ================= */
const isRepeated = s => /^(\d)\1+$/.test(s)
const isSequential = s => "0123456789".includes(s) || "9876543210".includes(s)

function isValidThaiCID(id){
  if(!/^\d{13}$/.test(id)) return false
  if(isRepeated(id)) return false
  let sum=0
  for(let i=0;i<12;i++) sum+=id[i]*(13-i)
  return ((11-sum%11)%10)==id[12]
}

function isValidCitizenOrPassport(v){
  if(/^\d+$/.test(v)){
    if(v.length===13) return isValidThaiCID(v)
    if(v.length>=6 && v.length<=9 && !isRepeated(v) && !isSequential(v)) return true
    return false
  }
  return /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z0-9]{6,20}$/.test(v)
}

/* ================= Realtime ================= */
function triggerRealtimeCheck(){
  const v=citizen_id.value.trim()
  if(!v){
    idFeedback.textContent=""
    setSubmitEnabled(false)
    return
  }
  if(isValidCitizenOrPassport(v)){
    idFeedback.textContent=i18n[currentLang].valid
    idFeedback.className="text-green-600 text-sm"
    setSubmitEnabled(true)
  }else{
    idFeedback.textContent=i18n[currentLang].invalid
    idFeedback.className="text-red-600 text-sm"
    setSubmitEnabled(false)
  }
}
citizen_id.addEventListener("input", triggerRealtimeCheck)

/* ================= Prefix / Language ================= */
function renderPrefix(){
  prefix.innerHTML=""
  i18n[currentLang].prefixes.forEach(p=>{
    const o=document.createElement("option")
    o.value=p.v; o.textContent=p.t
    prefix.appendChild(o)
  })
}
function setLang(l){
  currentLang=l
  title.innerText=i18n[l].title
  subtitle.innerText=i18n[l].subtitle
  submitBtn.innerText=i18n[l].submit
  renderPrefix()
  triggerRealtimeCheck()
}

/* ================= Submit (OCR + DB) ================= */
registerForm.addEventListener("submit", async e=>{
  e.preventDefault()
  showLoading(true)
  loadingText.innerText="กำลังตรวจสอบสลิป..."

  try{
    const cid=citizen_id.value.trim()
    const ext=slip.files[0].name.split(".").pop()
    const path=`${cid}_${Date.now()}.${ext}`

    await sb.storage.from("payment-slips").upload(path, slip.files[0])
    const slip_url = sb.storage.from("payment-slips").getPublicUrl(path).data.publicUrl

    const ocrRes = await fetch(OCR_FUNCTION_URL,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${SUPABASE_ANON_KEY}`
      },
      body:JSON.stringify({ imageUrl: slip_url })
    })

    const ocr = await ocrRes.json()

    if(!ocr.valid || ocr.amount !== REGISTRATION_FEE[ocr.currency]){
      throw "ยอดเงินไม่ถูกต้อง"
    }

    await sb.from("registrations").insert({
      prefix:prefix.value,
      first_name:first_name.value,
      last_name:last_name.value,
      phone:phone.value,
      citizen_id:cid,
      email:email.value,
      slip_url,
      status:"pending",
      ocr_amount:ocr.amount,
      ocr_currency:ocr.currency,
      ocr_text:ocr.text
    })

    Swal.fire("สำเร็จ","ระบบได้รับข้อมูลแล้ว","success")
    registerForm.reset()
    setSubmitEnabled(false)

  }catch(err){
    Swal.fire("ไม่สำเร็จ", err.toString(), "error")
  }

  showLoading(false)
})

/* ================= INIT ================= */
setLang("th")
</script>

</body>
</html>
