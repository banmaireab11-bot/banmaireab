<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Approve Dashboard | Ban Mai Riab School</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
  emailjs.init("YOUR_EMAILJS_PUBLIC_KEY")
</script>

<style>
  body {
    background: linear-gradient(to bottom right, #f0f9ff, #ffffff);
  }
</style>
</head>

<body class="min-h-screen p-6">

<!-- ================= Header ================= -->
<div class="max-w-7xl mx-auto mb-6">
  <h1 class="text-3xl font-bold text-sky-700">
    ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡πà‡∏á
  </h1>
  <p class="text-gray-600 mt-1">
    ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏°‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö
  </p>
</div>

<!-- ================= Dashboard ================= -->
<div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">

  <div class="bg-white rounded-xl shadow p-5 border-l-4 border-sky-600">
    <p class="text-gray-500">‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
    <p id="totalCount" class="text-3xl font-bold text-sky-700">0</p>
  </div>

  <div class="bg-white rounded-xl shadow p-5 border-l-4 border-green-600">
    <p class="text-gray-500">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</p>
    <p id="approvedCount" class="text-3xl font-bold text-green-600">0</p>
  </div>

  <div class="bg-white rounded-xl shadow p-5 border-l-4 border-orange-500">
    <p class="text-gray-500">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</p>
    <p id="pendingCount" class="text-3xl font-bold text-orange-500">0</p>
  </div>

</div>

<!-- ================= Filter ================= -->
<div class="max-w-7xl mx-auto mb-6 flex items-center gap-3">
  <label class="text-gray-700 font-medium">
    ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:
  </label>
  <select id="statusFilter"
    class="border rounded px-3 py-2"
    onchange="applyFilter()">
    <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
    <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
  </select>
</div>

<!-- ================= Cards ================= -->
<div class="max-w-7xl mx-auto">
  <div id="cardList" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
    <!-- cards -->
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://etnvagsxrrglysavibfe.supabase.co"
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV0bnZhZ3N4cnJnbHlzYXZpYmZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTkyMDEsImV4cCI6MjA4NTg5NTIwMX0.CgaLjOq8V3C8y3291TjsZqtxKfheYNe7ddUqzqg77Io"
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

// EmailJS config
const EMAIL_SERVICE_ID = "service_w51dn0v"
const EMAIL_TEMPLATE_ID = "template_fkwen1e"

let allData = []
const cardList = document.getElementById("cardList")

/* ================= LOAD DATA ================= */
async function loadData(){
  const { data, error } = await sb
    .from("registrations")
    .select("*")
    .order("created_at", { ascending: false })

  if(error){
    Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error")
    return
  }

  allData = data
  renderDashboard(allData)
  applyFilter()
}

/* ================= DASHBOARD ================= */
function renderDashboard(data){
  const total = data.length
  const approved = data.filter(d => d.status === "approved").length
  const pending = data.filter(d => d.status !== "approved").length

  document.getElementById("totalCount").innerText = total
  document.getElementById("approvedCount").innerText = approved
  document.getElementById("pendingCount").innerText = pending
}

/* ================= FILTER ================= */
function applyFilter(){
  const status = document.getElementById("statusFilter").value
  let filtered = allData

  if(status !== "all"){
    filtered = allData.filter(d => d.status === status)
  }

  renderCards(filtered)
}

/* ================= CARDS ================= */
function renderCards(data){
  cardList.innerHTML = ""

  if(data.length === 0){
    cardList.innerHTML = `
      <div class="col-span-full text-center text-gray-500">
        ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£
      </div>
    `
    return
  }

  data.forEach(d => {
    const statusColor = d.status === "approved"
      ? "bg-green-100 text-green-700"
      : "bg-orange-100 text-orange-700"

    const btn = d.status === "approved"
      ? `<span class="text-green-600 font-semibold">‚úî ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</span>`
      : `<button onclick="approve('${d.id}')"
           class="w-full mt-3 bg-green-600 text-white py-2 rounded hover:bg-green-700">
           ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
         </button>`

    cardList.innerHTML += `
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm px-2 py-1 rounded ${statusColor}">
            ${d.status === "approved" ? "Approved" : "Pending"}
          </span>
        </div>

        <h3 class="font-bold text-lg text-gray-800">
          ${d.prefix}${d.first_name} ${d.last_name}
        </h3>

        <p class="text-sm text-gray-600 mt-1">
          ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£ / Passport:
          <span class="font-medium">${d.citizen_id}</span>
        </p>

        <p class="text-sm text-gray-600">
          ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:
          <span class="font-medium">${d.phone}</span>
        </p>

        <div class="mt-3">
          <img src="${d.slip_url}"
               onclick="viewImage('${d.slip_url}')"
               class="w-full h-48 object-cover rounded cursor-pointer border">
        </div>

        ${btn}
      </div>
    `
  })
}

/* ================= APPROVE ================= */
async function approve(id){
  const confirm = await Swal.fire({
    title: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà",
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥",
    cancelButtonText: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
  })

  if(!confirm.isConfirmed) return

  const user = allData.find(u => u.id === id)
  if(!user){
    Swal.fire("Error", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£", "error")
    return
  }

  // update status
  await sb.from("registrations")
    .update({ status: "approved" })
    .eq("id", id)

  // üìß send email via EmailJS
  emailjs.send(
    EMAIL_SERVICE_ID,
    EMAIL_TEMPLATE_ID,
    {
      fullname: `${user.prefix}${user.first_name} ${user.last_name}`,
      cid: user.citizen_id,
      email: user.email
    }
  )

  Swal.fire("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", "success")
}

/* ================= VIEW IMAGE ================= */
function viewImage(url){
  Swal.fire({
    imageUrl: url,
    imageAlt: "Slip",
    showConfirmButton: false
  })
}

/* ================= REALTIME ================= */
sb.channel("registrations-realtime")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "registrations" },
    () => loadData()
  )
  .subscribe()

/* ================= INIT ================= */
loadData()
</script>

</body>
</html>
